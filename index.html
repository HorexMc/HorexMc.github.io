<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>محرر الألعاب — PlayWeb</title>
<style>
  :root{
    --bg:#0f1724; --panel:#0b1220; --accent:#6ee7b7; --muted:#94a3b8; --card:#0b1630;
    --glass: rgba(255,255,255,0.04);
    color-scheme: dark;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Tahoma, sans-serif;background:linear-gradient(180deg,#071023 0%, #05122a 100%); color:#e6eef8}
  .app{display:grid;grid-template-columns:440px 1fr;gap:18px;padding:18px;height:100%;box-sizing:border-box}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding-bottom:6px}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .controls{display:flex;gap:8px;align-items:center}
  button,select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.primary{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:white;border:none;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .left{display:flex;flex-direction:column;gap:12px}
  .editors{background:var(--card);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;min-height:0;box-shadow:0 6px 22px rgba(0,0,0,0.6)}
  .tabs{display:flex;gap:6px}
  .tab{padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
  .tab.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-color: rgba(255,255,255,0.04)}
  .textarea{width:100%;height:260px;background:transparent;border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:10px;color:inherit;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;font-size:13px;resize:vertical;outline:none}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .preview{background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;height:calc(100vh - 140px);box-shadow:0 6px 22px rgba(0,0,0,0.6)}
  .iframeWrap{flex:1;border-radius:8px;border:1px solid rgba(255,255,255,0.04);overflow:hidden;background:white}
  iframe#preview{width:100%;height:100%;border:0;background:white}
  .console{height:140px;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.5));border-radius:8px;padding:8px;margin-top:10px;overflow:auto;font-family:ui-monospace,monospace;font-size:13px;border:1px solid rgba(255,255,255,0.03)}
  .log{padding:6px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.03);color:#dbeafe}
  .warn{background:rgba(253,224,71,0.08);color:#ffd27a}
  .err{background:rgba(255,80,80,0.08);color:#ffb4b4}
  footer{grid-column:1/-1;padding:12px 18px;color:var(--muted);font-size:13px}
  .examples{min-width:180px}
  .btns{display:flex;gap:8px}
  @media(max-width:1000px){
    .app{grid-template-columns:1fr;overflow:auto}
    .left{order:2}
    .preview{order:1;height:50vh}
  }
</style>
</head>
<body>
  <div class="app" dir="rtl">
    <header>
      <h1>محرر الألعاب — PlayWeb (محرر مباشر)</h1>
      <div class="controls">
        <select id="examples" class="examples">
          <option value="">— اختر مثال جاهز —</option>
          <option value="pong">لعبة Pong بسيطة</option>
          <option value="bouncing">كرة ترتد (Canvas)</option>
          <option value="platform">مستوى منصة بسيط</option>
        </select>
        <div class="btns">
          <button id="runBtn" class="primary">▶ تشغيل (Play)</button>
          <button id="newTabBtn">فتح في نافذة جديدة</button>
          <button id="downloadBtn">تحميل HTML</button>
        </div>
      </div>
    </header>

    <div class="left">
      <div class="editors">
        <div class="tabs">
          <div class="tab active" data-target="html">HTML</div>
          <div class="tab" data-target="css">CSS</div>
          <div class="tab" data-target="js">JS</div>
        </div>

        <div id="htmlEditor" class="editorBlock">
<textarea id="html" class="textarea" spellcheck="false"><!-- اكتب هيكل HTML هنا -->
<div id="game-root">
  <h2 style="text-align:center;color:#0b1220">اضغط Play لتجربة الكود</h2>
  <canvas id="game" width="640" height="360" style="display:block;margin:12px auto;border:1px solid #ddd;background:#fff"></canvas>
</div>
</textarea>
        </div>

        <div id="cssEditor" class="editorBlock" style="display:none">
<textarea id="css" class="textarea" spellcheck="false">/* اكتب CSS هنا */
body{font-family:Inter,Arial;background:linear-gradient(180deg,#e6f7ff,#ffffff);color:#000}
#game-root h2{color:#111}
</textarea>
        </div>

        <div id="jsEditor" class="editorBlock" style="display:none">
<textarea id="js" class="textarea" spellcheck="false">// اكتب جافاسكربت اللعبة هنا
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let x = 50, y = 50;
let vx = 2, vy = 2;

function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#3b82f6';
  ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.fill();
  x += vx; y += vy;
  if(x<18 || x>canvas.width-18) vx *= -1;
  if(y<18 || y>canvas.height-18) vy *= -1;
  requestAnimationFrame(loop);
}

loop();
</textarea>
        </div>

        <div class="row">
          <div class="small">أعراض: يمكنك الكتابة مباشرة، ثم اضغط Play لتشغيل</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="clearBtn">مسح</button>
        <button id="resetBtn">إعادة القوالب الافتراضية</button>
        <div style="flex:1"></div>
      </div>
    </div>

    <div class="preview">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="font-size:14px;color:var(--muted)">معاينة مباشرة</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="small">Console</div>
        </div>
      </div>

      <div class="iframeWrap" id="iframeWrap">
        <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>

      <div class="console" id="console"></div>
    </div>

    <footer>
      نصائح: استخدم Canvas للألعاب الصغيرة، أو DOM + CSS للألعاب التفاعلية. اضغط "فتح في نافذة جديدة" لاختبار الأداء دون قيود الـ iframe.
    </footer>
  </div>

<script>
  // عناصر
  const tabs = document.querySelectorAll('.tab');
  const htmlBlock = document.getElementById('htmlEditor');
  const cssBlock = document.getElementById('cssEditor');
  const jsBlock = document.getElementById('jsEditor');
  const htmlTA = document.getElementById('html');
  const cssTA = document.getElementById('css');
  const jsTA = document.getElementById('js');
  const runBtn = document.getElementById('runBtn');
  const preview = document.getElementById('preview');
  const consoleEl = document.getElementById('console');
  const newTabBtn = document.getElementById('newTabBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const examples = document.getElementById('examples');
  const clearBtn = document.getElementById('clearBtn');
  const resetBtn = document.getElementById('resetBtn');

  // تبويبات
  tabs.forEach(t=>{
    t.onclick = ()=> {
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const target = t.dataset.target;
      htmlBlock.style.display = (target==='html') ? '' : 'none';
      cssBlock.style.display = (target==='css') ? '' : 'none';
      jsBlock.style.display = (target==='js') ? '' : 'none';
    };
  });

  // قوالب جاهزة
  const TEMPLATES = {
    pong: {
      html: ` <canvas id="game" width="800" height="400"></canvas> `,
      css: `body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:#030712;color:#fff}canvas{background:#041426;border:2px solid #0ea5a5}`,
      js: `const canvas = document.getElementById('game'); const c = canvas.getContext('2d');
let p1 = {x:10,y:150,w:10,h:100}, p2={x:780,y:150,w:10,h:100}, ball={x:400,y:200, vx:3, vy:2, r:8};
function rect(r){c.fillRect(r.x,r.y,r.w,r.h);}
function draw(){c.clearRect(0,0,canvas.width,canvas.height); c.fillStyle='#fff'; rect(p1); rect(p2);
c.beginPath(); c.arc(ball.x,ball.y,ball.r,0,Math.PI*2); c.fill();
ball.x += ball.vx; ball.y += ball.vy;
if(ball.y<ball.r||ball.y>canvas.height-ball.r) ball.vy*=-1;
if(ball.x<0||ball.x>canvas.width) { ball.x=400; ball.y=200; }
if(ball.x < p1.x+p1.w && ball.y>p1.y && ball.y<p1.y+p1.h) ball.vx *= -1;
if(ball.x > p2.x && ball.y>p2.y && ball.y<p2.y+p2.h) ball.vx *= -1;
requestAnimationFrame(draw);
} draw();
window.addEventListener('mousemove', e=>{ const r=canvas.getBoundingClientRect(); p2.y = e.clientY - r.top - p2.h/2; });`
    },
    bouncing: {
      html: `<canvas id="game" width="640" height="360"></canvas>`,
      css: `body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:linear-gradient(180deg,#fef3c7,#fef2f2)}canvas{border:2px solid #333}`,
      js: `const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d'); let x=320,y=180, vx=4, vy=3;
function loop(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fill(); x+=vx; y+=vy;
if(x<20||x>canvas.width-20) vx*=-1; if(y<20||y>canvas.height-20) vy*=-1; requestAnimationFrame(loop);} loop();`
    },
    platform: {
      html: `<canvas id="game" width="800" height="400"></canvas>`,
      css: `body{margin:0;background:#0b1220;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh}`,
      js: `const canvas=document.getElementById('game');const c=canvas.getContext('2d');let player={x:50,y:300,w:30,h:40,vy:0,onGround:false};
const keys={left:false,right:false,jump:false}; const gravity=0.8;
const platforms=[{x:0,y:360,w:800,h:40},{x:200,y:280,w:120,h:10},{x:400,y:220,w:140,h:10}];
window.addEventListener('keydown',e=>{ if(e.code==='ArrowLeft')keys.left=true; if(e.code==='ArrowRight')keys.right=true; if(e.code==='Space')keys.jump=true;});
window.addEventListener('keyup',e=>{ if(e.code==='ArrowLeft')keys.left=false; if(e.code==='ArrowRight')keys.right=false; if(e.code==='Space')keys.jump=false;});
function loop(){ c.clearRect(0,0,canvas.width,canvas.height); c.fillStyle='#111'; platforms.forEach(p=>{c.fillRect(p.x,p.y,p.w,p.h)});
player.vy+=gravity; player.y+=player.vy; if(keys.left) player.x-=4; if(keys.right) player.x+=4;
player.onGround=false;
platforms.forEach(p=>{ if(player.x+player.w>p.x && player.x<p.x+p.w && player.y+player.h>p.y && player.y+player.h< p.y+10 && player.vy>=0){ player.y=p.y-player.h; player.vy=0; player.onGround=true;}});
if(keys.jump && player.onGround){ player.vy=-14;}
c.fillStyle='#06b6d4'; c.fillRect(player.x,player.y,player.w,player.h);
requestAnimationFrame(loop);} loop();`
    }
  };

  examples.onchange = ()=>{
    const v = examples.value;
    if(!v) return;
    const t = TEMPLATES[v];
    htmlTA.value = t.html;
    cssTA.value = t.css;
    jsTA.value = t.js;
    // افتح تبويب الـ HTML بعد تحميل القالب
    tabs.forEach(t=>t.classList.remove('active'));
    document.querySelector('.tab[data-target="html"]').classList.add('active');
    htmlBlock.style.display=''; cssBlock.style.display='none'; jsBlock.style.display='none';
  };

  // توليد الـ srcdoc (نحقن كود لالتقاط console)
  function buildSrcDoc(){
    const html = htmlTA.value;
    const css = cssTA.value;
    const js = jsTA.value;

    // نص نحقنه داخل صفحة المعاينة لالتقاط console وإرسال الرسائل للصفحة الأم
    const consoleBridge = `
<script>
(function(){
  function send(level,args){
    try{ parent.postMessage({type:'pw_console', level:level, args: args.map(a=>{ try{ return typeof a === 'object' ? JSON.stringify(a) : String(a);}catch(e){return String(a);} })}, '*'); }
    catch(e){}
  }
  ['log','warn','error','info'].forEach(l=>{
    const orig = console[l];
    console[l] = function(...a){ send(l,a); orig.apply(console,a); };
  });
  window.addEventListener('error', function(event){
    send('error', [event.message + ' (Line:' + (event.lineno||'?') + ')']);
  });
  // الدعم لطباعة Promise rejections
  window.addEventListener('unhandledrejection', function(e){ send('error', ['UnhandledRejection: '+ (e.reason && e.reason.stack ? e.reason.stack : e.reason)]); });
})();
</script>
`;

    // اجمع الصفحة كاملة
    const full = `<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<style>${css}</style></head><body>${html}
<script>
try{
${js}
}catch(e){
  console.error(e);
}
</script>
${consoleBridge}
</body></html>`;
    return full;
  }

  // تشغيل المعاينة
  function runPreview(){
    clearConsole();
    const src = buildSrcDoc();
    // استخدم srcdoc لو كان متاحًا
    preview.srcdoc = src;
  }

  // استماع لرسائل الـ console من iframe
  window.addEventListener('message', (ev)=>{
    try{
      const d = ev.data;
      if(!d || d.type !== 'pw_console') return;
      const lvl = d.level || 'log';
      d.args.forEach(a=>{
        appendConsole(lvl, a);
      });
    }catch(e){}
  });

  function appendConsole(level, text){
    const div = document.createElement('div');
    div.className = (level==='error' || level==='err') ? 'log err' : (level==='warn' ? 'log warn' : 'log');
    const t = document.createElement('div');
    t.textContent = '['+level+'] ' + text;
    div.appendChild(t);
    consoleEl.appendChild(div);
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  function clearConsole(){ consoleEl.innerHTML = ''; appendConsole('info','Console جاهز'); }

  // فتح في نافذة جديدة (نستخدم Blob URL)
  function openInNewWindow(){
    const src = buildSrcDoc();
    const blob = new Blob([src], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
    // حرر ال URL بعد قليل
    setTimeout(()=> URL.revokeObjectURL(url), 20000);
  }

  // تحميل ملف HTML
  function downloadHTML(){
    const src = buildSrcDoc();
    const blob = new Blob([src], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'game.html';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(a.href), 20000);
  }

  // أزرار
  runBtn.onclick = runPreview;
  newTabBtn.onclick = openInNewWindow;
  downloadBtn.onclick = downloadHTML;
  clearBtn.onclick = ()=>{ if(confirm('هل تريد مسح كل الحقول؟')){ htmlTA.value=''; cssTA.value=''; jsTA.value=''; clearConsole(); } };
  resetBtn.onclick = ()=> {
    if(confirm('إعادة القوالب الافتراضية؟ سيستبدل ما كتبته.')) {
      htmlTA.value = `<!-- اكتب هيكل HTML هنا -->
<div id="game-root">
  <h2 style="text-align:center;color:#0b1220">اضغط Play لتجربة الكود</h2>
  <canvas id="game" width="640" height="360" style="display:block;margin:12px auto;border:1px solid #ddd;background:#fff"></canvas>
</div>`;
      cssTA.value = `/* اكتب CSS هنا */\nbody{font-family:Inter,Arial;background:linear-gradient(180deg,#e6f7ff,#ffffff);color:#000}\n#game-root h2{color:#111}`;
      jsTA.value = `// اكتب جافاسكربت اللعبة هنا\nconst canvas = document.getElementById('game');\nconst ctx = canvas.getContext('2d');\n\nlet x = 50, y = 50;\nlet vx = 2, vy = 2;\n\nfunction loop(){\n  ctx.clearRect(0,0,canvas.width,canvas.height);\n  ctx.fillStyle = '#3b82f6';\n  ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.fill();\n  x += vx; y += vy;\n  if(x<18 || x>canvas.width-18) vx *= -1;\n  if(y<18 || y>canvas.height-18) vy *= -1;\n  requestAnimationFrame(loop);\n}\n\nloop();`;
      clearConsole();
    }
  };

  // تشغيل مبدئي
  clearConsole();
  runPreview();

  // اختصار لوحة المفاتيح Ctrl/Cmd+Enter => تشغيل
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ e.preventDefault(); runPreview(); }
  });

</script>
</body>
</html>
